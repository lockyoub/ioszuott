name: æ„å»ºiOSåº”ç”¨ (æœªç­¾åIPA)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_configuration:
        description: 'æ„å»ºé…ç½®'
        required: true
        default: 'Release'
        type: choice
        options:
        - Debug
        - Release

env:
  XCODE_VERSION: '15.4'
  IOS_DEPLOYMENT_TARGET: '15.0'
  SCHEME_NAME: 'StockTradingApp'
  CONFIGURATION: ${{ github.event.inputs.build_configuration || 'Release' }}

jobs:
  build:
    name: æ„å»ºæœªç­¾åIPAåŒ…
    runs-on: macos-14
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Xcodeç‰ˆæœ¬
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
        
    - name: æ˜¾ç¤ºXcodeä¿¡æ¯
      run: |
        xcodebuild -version
        xcrun simctl list runtimes
        
    - name: åˆ›å»ºXcodeé¡¹ç›®ç»“æ„
      run: |
        echo "ğŸ“ åˆ›å»ºXcodeé¡¹ç›®ç»“æ„..."
        
        # åˆ›å»ºé¡¹ç›®ç›®å½•ç»“æ„
        mkdir -p StockTradingApp.xcodeproj
        mkdir -p StockTradingApp/Resources
        mkdir -p StockTradingApp/Supporting\ Files
        
        # ç§»åŠ¨æºæ–‡ä»¶åˆ°æ ‡å‡†é¡¹ç›®ç»“æ„
        cp -r user_input_files/Models/ StockTradingApp/ 2>/dev/null || echo "Modelsç›®å½•ä¸å­˜åœ¨"
        cp -r user_input_files/Views/ StockTradingApp/ 2>/dev/null || echo "Viewsç›®å½•ä¸å­˜åœ¨"
        cp -r user_input_files/Services/ StockTradingApp/ 2>/dev/null || echo "Servicesç›®å½•ä¸å­˜åœ¨"
        cp -r user_input_files/Utils/ StockTradingApp/ 2>/dev/null || echo "Utilsç›®å½•ä¸å­˜åœ¨"
        cp -r user_input_files/Performance/ StockTradingApp/ 2>/dev/null || echo "Performanceç›®å½•ä¸å­˜åœ¨"
        cp -r user_input_files/Foundation/ StockTradingApp/ 2>/dev/null || echo "Foundationç›®å½•ä¸å­˜åœ¨"
        cp -r user_input_files/TradingDataModel.xcdatamodeld/ StockTradingApp/ 2>/dev/null || echo "Core Dataæ¨¡å‹ä¸å­˜åœ¨"
        cp user_input_files/StockTradingApp.swift StockTradingApp/ 2>/dev/null || echo "ä¸»åº”ç”¨æ–‡ä»¶ä¸å­˜åœ¨"
        cp user_input_files/Info.plist StockTradingApp/Supporting\ Files/ 2>/dev/null || echo "Info.plistä¸å­˜åœ¨"
        
        # æ£€æŸ¥æ–‡ä»¶å¤åˆ¶ç»“æœ
        echo "ğŸ“‹ æ£€æŸ¥å¤åˆ¶çš„æ–‡ä»¶..."
        find StockTradingApp -name "*.swift" | head -10
        
        echo "âœ… é¡¹ç›®ç»“æ„åˆ›å»ºå®Œæˆ"
        
    - name: ç”ŸæˆXcodeé¡¹ç›®æ–‡ä»¶
      run: |
        echo "ğŸ”§ ç”ŸæˆXcodeé¡¹ç›®é…ç½®..."
        
        # åˆ›å»ºPackage.swiftç”¨äºSPMä¾èµ–ç®¡ç†
        cat > Package.swift << 'EOF'
        // swift-tools-version:5.9
        import PackageDescription
        
        let package = Package(
            name: "StockTradingApp",
            platforms: [
                .iOS(.v15)
            ],
            products: [
                .library(
                    name: "StockTradingApp",
                    targets: ["StockTradingApp"]),
            ],
            dependencies: [
                // æ·»åŠ å¸¸ç”¨ä¾èµ–
            ],
            targets: [
                .target(
                    name: "StockTradingApp",
                    dependencies: []),
                .testTarget(
                    name: "StockTradingAppTests",
                    dependencies: ["StockTradingApp"]),
            ]
        )
        EOF
        
        echo "âœ… Package.swiftåˆ›å»ºå®Œæˆ"
        
    - name: ä½¿ç”¨xcodegenç”Ÿæˆé¡¹ç›®
      run: |
        echo "ğŸ“¦ å®‰è£…xcodegen..."
        brew install xcodegen
        
        echo "ğŸ”§ åˆ›å»ºproject.ymlé…ç½®..."
        cat > project.yml << 'EOF'
        name: StockTradingApp
        
        options:
          bundleIdPrefix: com.stocktrading
          deploymentTarget:
            iOS: "15.0"
          developmentLanguage: zh-Hans
          
        settings:
          IPHONEOS_DEPLOYMENT_TARGET: 15.0
          SWIFT_VERSION: 5.9
          TARGETED_DEVICE_FAMILY: "1,2"
          SUPPORTS_MACCATALYST: false
          MARKETING_VERSION: "1.0.0"
          CURRENT_PROJECT_VERSION: "1"
          
        targets:
          StockTradingApp:
            type: application
            platform: iOS
            deploymentTarget: "15.0"
            sources:
              - StockTradingApp
            resources:
              - StockTradingApp/Resources
            info:
              path: StockTradingApp/Supporting Files/Info.plist
            settings:
              PRODUCT_BUNDLE_IDENTIFIER: com.stocktrading.app
              PRODUCT_NAME: StockTradingApp
              INFOPLIST_FILE: StockTradingApp/Supporting Files/Info.plist
              ASSETCATALOG_COMPILER_APPICON_NAME: AppIcon
              CODE_SIGN_STYLE: Manual
              CODE_SIGN_IDENTITY: ""
              PROVISIONING_PROFILE_SPECIFIER: ""
              DEVELOPMENT_TEAM: ""
            preBuildScripts:
              - name: "æ£€æŸ¥æºæ–‡ä»¶"
                script: |
                  echo "ğŸ“‹ æ£€æŸ¥é¡¹ç›®æºæ–‡ä»¶..."
                  find "${SRCROOT}/StockTradingApp" -name "*.swift" | head -10
            coreDataModels:
              - StockTradingApp/TradingDataModel.xcdatamodeld
        EOF
        
        echo "ğŸš€ ç”ŸæˆXcodeé¡¹ç›®..."
        xcodegen generate
        
        echo "âœ… Xcodeé¡¹ç›®ç”Ÿæˆå®Œæˆ"
        
    - name: è§£æå’Œä¿®å¤Swiftä»£ç ä¾èµ–
      run: |
        echo "ğŸ” åˆ†æSwiftä»£ç ä¾èµ–..."
        
        # æ£€æŸ¥ç¼ºå¤±çš„ç±»å’Œåè®®
        grep -r "class.*:" StockTradingApp/ | head -10 || true
        grep -r "protocol.*:" StockTradingApp/ | head -10 || true
        
        # åˆ›å»ºç¼ºå¤±çš„åŸºç¡€ç±»
        mkdir -p StockTradingApp/Foundation
        
        # åˆ›å»ºAppDelegate.swift
        cat > StockTradingApp/Foundation/AppDelegate.swift << 'EOF'
        import UIKit
        import CoreData
        
        class AppDelegate: NSObject, UIApplicationDelegate {
            func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?) -> Bool {
                return true
            }
            
            func application(_ application: UIApplication, didReceiveRemoteNotification userInfo: [AnyHashable: Any], fetchCompletionHandler completionHandler: @escaping (UIBackgroundFetchResult) -> Void) {
                completionHandler(.newData)
            }
        }
        EOF
        
        # åˆ›å»ºAppState.swift
        cat > StockTradingApp/Foundation/AppState.swift << 'EOF'
        import Foundation
        import Combine
        
        class AppState: ObservableObject {
            @Published var isLoggedIn: Bool = false
            @Published var currentUser: String = ""
            @Published var theme: String = "light"
            
            init() {
                // åˆå§‹åŒ–åº”ç”¨çŠ¶æ€
            }
        }
        EOF
        
        echo "âœ… åŸºç¡€ç±»åˆ›å»ºå®Œæˆ"
        
    - name: æ¸…ç†æ„å»ºå¹¶æ„å»ºé¡¹ç›®
      run: |
        echo "ğŸ§¹ æ¸…ç†æ„å»ºç¼“å­˜..."
        xcodebuild clean -project StockTradingApp.xcodeproj -scheme ${{ env.SCHEME_NAME }} -configuration ${{ env.CONFIGURATION }}
        
        echo "ğŸ”¨ å¼€å§‹æ„å»ºé¡¹ç›®..."
        xcodebuild build \
          -project StockTradingApp.xcodeproj \
          -scheme ${{ env.SCHEME_NAME }} \
          -configuration ${{ env.CONFIGURATION }} \
          -destination 'generic/platform=iOS' \
          -allowProvisioningUpdates \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
          
    - name: åˆ›å»ºå½’æ¡£
      run: |
        echo "ğŸ“¦ åˆ›å»ºåº”ç”¨å½’æ¡£..."
        xcodebuild archive \
          -project StockTradingApp.xcodeproj \
          -scheme ${{ env.SCHEME_NAME }} \
          -configuration ${{ env.CONFIGURATION }} \
          -destination 'generic/platform=iOS' \
          -archivePath build/StockTradingApp.xcarchive \
          -allowProvisioningUpdates \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
          
    - name: å¯¼å‡ºæœªç­¾åIPA
      run: |
        echo "ğŸ“± å¯¼å‡ºæœªç­¾åIPAåŒ…..."
        
        # åˆ›å»ºå¯¼å‡ºé€‰é¡¹plist
        cat > ExportOptions.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>development</string>
            <key>compileBitcode</key>
            <false/>
            <key>signingStyle</key>
            <string>manual</string>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>thinning</key>
            <string>&lt;none&gt;</string>
        </dict>
        </plist>
        EOF
        
        # å¯¼å‡ºIPA
        xcodebuild -exportArchive \
          -archivePath build/StockTradingApp.xcarchive \
          -exportPath build/ipa \
          -exportOptionsPlist ExportOptions.plist \
          -allowProvisioningUpdates
          
    - name: é‡å‘½åå’Œå‡†å¤‡å‘å¸ƒæ–‡ä»¶
      run: |
        echo "ğŸ“‹ å‡†å¤‡å‘å¸ƒæ–‡ä»¶..."
        
        # è·å–æ„å»ºä¿¡æ¯
        BUILD_DATE=$(date "+%Y%m%d_%H%M%S")
        COMMIT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        
        # é‡å‘½åIPAæ–‡ä»¶
        if [ -f "build/ipa/StockTradingApp.ipa" ]; then
          mv "build/ipa/StockTradingApp.ipa" "build/StockTradingApp_${BUILD_DATE}_${COMMIT_SHA}_unsigned.ipa"
          echo "âœ… IPAæ–‡ä»¶é‡å‘½åå®Œæˆ"
        else
          echo "âŒ æœªæ‰¾åˆ°IPAæ–‡ä»¶ï¼Œæ£€æŸ¥æ„å»ºè¿‡ç¨‹"
          ls -la build/ipa/ || true
          exit 1
        fi
        
        # åˆ›å»ºæ„å»ºä¿¡æ¯æ–‡ä»¶
        cat > build/build_info.txt << EOF
        æ„å»ºä¿¡æ¯
        ========
        åº”ç”¨åç§°: è‚¡ç¥¨äº¤æ˜“ç³»ç»Ÿ
        ç‰ˆæœ¬: 1.0.0 (1)
        æ„å»ºé…ç½®: ${{ env.CONFIGURATION }}
        æ„å»ºæ—¶é—´: ${BUILD_DATE}
        æäº¤å“ˆå¸Œ: ${{ github.sha }}
        åˆ†æ”¯: ${{ github.ref_name }}
        æ„å»ºç¯å¢ƒ: GitHub Actions (macOS-14)
        Xcodeç‰ˆæœ¬: ${{ env.XCODE_VERSION }}
        iOSç›®æ ‡ç‰ˆæœ¬: ${{ env.IOS_DEPLOYMENT_TARGET }}
        
        âš ï¸  æ³¨æ„äº‹é¡¹:
        - æ­¤ä¸ºæœªç­¾åçš„IPAåŒ…
        - éœ€è¦å¼€å‘è€…è¯ä¹¦æ‰èƒ½å®‰è£…åˆ°çœŸæœº
        - å¯ç”¨äºæ¨¡æ‹Ÿå™¨æµ‹è¯•æˆ–é‡æ–°ç­¾å
        
        ğŸ“¦ å®‰è£…è¯´æ˜:
        1. ä½¿ç”¨Xcodeå®‰è£…åˆ°æ¨¡æ‹Ÿå™¨
        2. ä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·é‡æ–°ç­¾ååå®‰è£…
        3. ä¼ä¸šç¯å¢ƒå¯é…ç½®ä¼ä¸šè¯ä¹¦ç­¾å
        EOF
        
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: StockTradingApp-unsigned-ipa-${{ github.run_number }}
        path: |
          build/*.ipa
          build/build_info.txt
        retention-days: 30
        
    - name: æ„å»ºæ‘˜è¦
      run: |
        echo "## ğŸ‰ æ„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“‹ æ„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **åº”ç”¨åç§°**: è‚¡ç¥¨äº¤æ˜“ç³»ç»Ÿ" >> $GITHUB_STEP_SUMMARY
        echo "- **ç‰ˆæœ¬**: 1.0.0 (1)" >> $GITHUB_STEP_SUMMARY
        echo "- **æ„å»ºé…ç½®**: ${{ env.CONFIGURATION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ç›®æ ‡iOSç‰ˆæœ¬**: ${{ env.IOS_DEPLOYMENT_TARGET }}+" >> $GITHUB_STEP_SUMMARY
        echo "- **æ„å»ºæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“¦ äº§ç‰©ä¸‹è½½" >> $GITHUB_STEP_SUMMARY
        echo "è¯·åœ¨Actionsé¡µé¢ä¸‹è½½ \`StockTradingApp-unsigned-ipa-${{ github.run_number }}\` æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âš ï¸ é‡è¦è¯´æ˜" >> $GITHUB_STEP_SUMMARY
        echo "- æ­¤IPAåŒ…**æœªç»ç­¾å**ï¼Œæ— æ³•ç›´æ¥å®‰è£…åˆ°iOSè®¾å¤‡" >> $GITHUB_STEP_SUMMARY
        echo "- é€‚ç”¨äºæ¨¡æ‹Ÿå™¨æµ‹è¯•æˆ–åç»­é‡æ–°ç­¾å" >> $GITHUB_STEP_SUMMARY
        echo "- å¦‚éœ€çœŸæœºå®‰è£…ï¼Œè¯·ä½¿ç”¨å¼€å‘è€…è¯ä¹¦é‡æ–°ç­¾å" >> $GITHUB_STEP_SUMMARY

  # å¯é€‰: è‡ªåŠ¨åˆ›å»ºRelease (ä»…åœ¨mainåˆ†æ”¯)
  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: StockTradingApp-unsigned-ipa-${{ github.run_number }}
        path: ./artifacts
        
    - name: åˆ›å»ºRelease
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0.0-build.${{ github.run_number }}
        name: iOSè‚¡ç¥¨äº¤æ˜“ç³»ç»Ÿ v1.0.0 Build ${{ github.run_number }}
        body: |
          ## ğŸ“± iOSè‚¡ç¥¨äº¤æ˜“ç³»ç»Ÿ æœªç­¾åç‰ˆæœ¬
          
          **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
          **æäº¤ä¿¡æ¯**: ${{ github.event.head_commit.message }}
          
          ### ğŸ“‹ åŠŸèƒ½ç‰¹æ€§
          - å®æ—¶è‚¡ç¥¨æ•°æ®æ˜¾ç¤º
          - å¤šç­–ç•¥äº¤æ˜“ç³»ç»Ÿ  
          - Kçº¿å›¾è¡¨åˆ†æ
          - é£é™©ç®¡ç†ç³»ç»Ÿ
          - æŠ•èµ„ç»„åˆç®¡ç†
          
          ### ğŸ“¦ å®‰è£…è¯´æ˜
          1. ä¸‹è½½ `.ipa` æ–‡ä»¶
          2. ä½¿ç”¨Xcodeå®‰è£…åˆ°iOSæ¨¡æ‹Ÿå™¨æµ‹è¯•
          3. å¦‚éœ€çœŸæœºå®‰è£…ï¼Œè¯·é‡æ–°ç­¾åæˆ–è”ç³»å¼€å‘è€…
          
          ### âš ï¸ é‡è¦æé†’
          - æ­¤ä¸º**æœªç­¾å**ç‰ˆæœ¬ï¼Œä»…ä¾›å¼€å‘æµ‹è¯•
          - ä¸åŒ…å«æœ‰æ•ˆçš„å¼€å‘è€…è¯ä¹¦
          - æ— æ³•ç›´æ¥å®‰è£…åˆ°iOSçœŸæœºè®¾å¤‡
          
        files: ./artifacts/*
        draft: false
        prerelease: true
        generate_release_notes: true